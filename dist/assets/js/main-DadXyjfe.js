import{C as t,F as e,M as s,W as i,P as n,S as a,a as o,b as r,c as h,V as c,L as l,G as d,T as u,A as m,d as p,D as y,e as g,R as w,O as _,f,g as v,h as E,i as S,j as b,k as M,E as R,l as I,Q as L,m as P,B as A}from"./vendor-three-sNjzZa5f.js";import{W as T,S as x,M as k,C,R as B,a as D,V as N}from"./vendor-physics-BScoIrFj.js";!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const s of t)if("childList"===s.type)for(const t of s.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();const F={RENDERER:{ANTIALIAS:!0,PIXEL_RATIO:Math.min(window.devicePixelRatio,2),POWER_PREFERENCE:"high-performance",PRECISION:"highp",PHYSICALLY_CORRECT_LIGHTS:!0,TONE_MAPPING:3,TONE_MAPPING_EXPOSURE:1.2,LOGARITHMIC_DEPTH_BUFFER:!1},LOOP:{PHYSICS_TICK_RATE:1/60,MAX_SUB_STEPS:3,TIME_SCALE:1},CAMERA:{FOV:75,NEAR_CLIP:.1,FAR_CLIP:5e3,DEFAULT_POSITION:[0,5,10],DEFAULT_TARGET:[0,0,0]}},O=[0,-9.81,0],W=10,G=.001,$={DEFAULT:{friction:.3,restitution:.2},PLAYER:{friction:0,restitution:0},VEHICLE:{friction:.8,restitution:.1}},z={MOVEMENT:{WALK_SPEED:2.5,RUN_SPEED:6.5,CROUCH_SPEED:1.5,JUMP_FORCE:6.5},CAMERA:{TPS_OFFSET:[0,1.5,-3],TPS_OFFSET_AIM:[.5,1.5,-1.5],FPS_OFFSET:[0,1.6,.2]}},H={TIME:{REAL_SECONDS_PER_GAME_DAY:1440,START_TIME:28800,DAWN_START:5.5,DUSK_START:19}},V={MOVE_FORWARD:["KeyW","ArrowUp"],MOVE_BACKWARD:["KeyS","ArrowDown"],MOVE_LEFT:["KeyA","ArrowLeft"],MOVE_RIGHT:["KeyD","ArrowRight"],JUMP:["Space"],SPRINT:["ShiftLeft","ShiftRight"],CROUCH:["ControlLeft","KeyC"],INTERACT:["KeyE"],RELOAD:["KeyR"],INVENTORY:["KeyI","Tab"],OPEN_MOS:["KeyM"],PAUSE:["Escape","KeyP"],SWITCH_CAMERA:["KeyV"]},U="LifeRPG_SaveData",q=1,Y=["gamestate","player","world","economy","mos"],j="DEBUG",K={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,FATAL:5,NONE:6},J={[K.TRACE]:"TRACE",[K.DEBUG]:"DEBUG",[K.INFO]:"INFO",[K.WARN]:"WARN",[K.ERROR]:"ERROR",[K.FATAL]:"FATAL"},X={[K.TRACE]:"color: #808080",[K.DEBUG]:"color: #00f3ff",[K.INFO]:"color: #00ff88",[K.WARN]:"color: #ffaa00; font-weight: bold",[K.ERROR]:"color: #ff1100; font-weight: bold; font-size: 1.1em",[K.FATAL]:"color: #ffffff; background: #ff0000; font-weight: bold; padding: 2px 4px; border-radius: 3px"},Z={Core:"color: #b026ff",Engine:"color: #0088ff",Physics:"color: #ff8800",World:"color: #22cc22",Player:"color: #ee22ee",AI:"color: #ffff00",UI:"color: #00cccc",Audio:"color: #ff00ff",Network:"color: #888888",SaveSys:"color: #bbcc00"};const Q=new class{constructor(){this.currentLevel=K[j],this.history=[],this.maxHistory=1e3,this.subsystems=new Set,this.mutedSubsystems=new Set,this.consoleListeners=[],this.startTime=performance.now()}setLevel(t){Object.values(K).includes(t)&&(this.currentLevel=t)}muteSubsystem(t){this.mutedSubsystems.add(t)}unmuteSubsystem(t){this.mutedSubsystems.delete(t)}addConsoleListener(t){"function"==typeof t&&this.consoleListeners.push(t)}_getFormattedTime(){const t=new Date,e=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0"),i=String(t.getSeconds()).padStart(2,"0"),n=String(t.getMilliseconds()).padStart(3,"0");return`[+${((performance.now()-this.startTime)/1e3).toFixed(2)}s | ${e}:${s}:${i}.${n}]`}_log(t,e,s,i=null){if(t<this.currentLevel||this.mutedSubsystems.has(e))return;this.subsystems.add(e);const n=this._getFormattedTime(),a=J[t].padEnd(5," "),o=`[${e}]`.padEnd(12," "),r=X[t]||"",h=Z[e]||"color: #aaaaaa",c="color: inherit; font-weight: normal; background: transparent",l={time:n,level:t,levelName:a.trim(),subsystem:e,message:s,data:i};this.history.push(l),this.history.length>this.maxHistory&&this.history.shift();for(const d of this.consoleListeners)d(l);if(t>=K.ERROR){const e=`%c${n}%c %c${a}%c %c${o}%c ${s}`,l=["color: #666666",c,r,c,h,c];i?t>=K.ERROR?console.error(e,...l,i):t===K.WARN?console.warn(e,...l,i):t===K.TRACE||t===K.DEBUG?console.debug(e,...l,i):console.log(e,...l,i):t>=K.ERROR?console.error(e,...l):t===K.WARN?console.warn(e,...l):t===K.TRACE||t===K.DEBUG?console.debug(e,...l):console.log(e,...l)}}trace(t,e,s=null){this._log(K.TRACE,t,e,s)}debug(t,e,s=null){this._log(K.DEBUG,t,e,s)}info(t,e,s=null){this._log(K.INFO,t,e,s)}warn(t,e,s=null){this._log(K.WARN,t,e,s)}error(t,e,s=null){this._log(K.ERROR,t,e,s)}fatal(t,e,s=null){this._log(K.FATAL,t,e,s),window&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("LIFE_FATAL_ERROR",{detail:{subsystem:t,message:e,data:s}}))}time(t,e,s){if(this.currentLevel>K.DEBUG||this.mutedSubsystems.has(t))return s();const i=performance.now(),n=s();if(n instanceof Promise)return n.then(s=>{const n=performance.now();return this.debug(t,`${e} took ${(n-i).toFixed(2)}ms`),s}).catch(s=>{const n=performance.now();throw this.error(t,`${e} FAILED after ${(n-i).toFixed(2)}ms`,s),s});{const s=performance.now();return this.debug(t,`${e} took ${(s-i).toFixed(2)}ms`),n}}dumpHistory(){return[...this.history]}clearHistory(){this.history=[]}};const tt=new class{constructor(){this.events=new Map,this.asyncQueue=[],this.isProcessingAsync=!1,this.ASYNC_TIME_BUDGET=5}on(t,e,s=10,i=null){this.events.has(t)||this.events.set(t,[]);const n=Math.random().toString(36).substr(2,9),a={id:n,callback:e,priority:s,context:i,once:!1},o=this.events.get(t);return o.push(a),o.sort((t,e)=>t.priority-e.priority),n}once(t,e,s=10,i=null){const n=this.on(t,e,s,i),a=this.events.get(t).find(t=>t.id===n);return a&&(a.once=!0),n}off(t,e=null){if(!this.events.has(t))return!1;if(!e)return this.events.delete(t),!0;const s=this.events.get(t),i=s.length,n="string"==typeof e;for(let a=s.length-1;a>=0;a--)(n&&s[a].id===e||!n&&s[a].callback===e)&&s.splice(a,1);return 0===s.length&&this.events.delete(t),s.length<i}emit(t,e={}){let s=0;this.events.has(t)&&(s+=this._invokeList(t,this.events.get(t),e));const i=t.split(":");if(i.length>1){const n=`${i[0]}:*`;if(this.events.has(n)){const i={...e,_wildcardTarget:t};s+=this._invokeList(n,this.events.get(n),i)}}return s>0}emitAsync(t,e={}){this.asyncQueue.push({eventName:t,data:e,timestamp:performance.now()})}_invokeList(t,e,s){if(!e||0===e.length)return 0;const i=[...e];let n=0;for(const o of i)try{o.context?o.callback.call(o.context,s):o.callback(s),n++,o.once&&this.off(t,o.id)}catch(a){Q.error("Core",`Event Callback Error inside [${t}]`,a)}return n}processAsync(){if(0===this.asyncQueue.length)return;this.isProcessingAsync=!0;const t=performance.now();for(;this.asyncQueue.length>0;){const{eventName:e,data:s}=this.asyncQueue.shift();if(this.emit(e,s),performance.now()-t>this.ASYNC_TIME_BUDGET){Q.warn("Core",`Async Event processing hit time budget limit (${this.ASYNC_TIME_BUDGET}ms). Remaining events: ${this.asyncQueue.length}`);break}}this.isProcessingAsync=!1}clearAll(){this.events.clear(),this.asyncQueue=[]}};const et=new class{constructor(){this.container=null,this.renderer=null,this.scene=null,this.camera=null,this.clock=new t,this.composer=null,this.frustum=new e,this.cameraViewProjectionMatrix=new s,this.isInitialized=!1,this.resizeObserver=null}init(t="game-canvas-container"){if(this.isInitialized)Q.warn("Engine","Le moteur est d√©j√† initialis√©.");else try{if(Q.info("Engine","Initialisation du Moteur 3D (Three.js)..."),this.container=document.getElementById(t),!this.container)throw new Error(`Container WebGL introuvable : #${t}`);this._setupRenderer(),this._setupScene(),this._setupCamera(),this._setupResizeHandlers(),tt.emit("engine:initialized",{renderer:this.renderer,scene:this.scene,camera:this.camera}),this.isInitialized=!0,Q.info("Engine","Moteur 3D initialis√© avec succ√®s !")}catch(e){Q.fatal("Engine","Erreur critique lors de l'initialisation du WebGL Renderer",e)}}_setupRenderer(){this.renderer=new i({antialias:F.RENDERER.ANTIALIAS,powerPreference:F.RENDERER.POWER_PREFERENCE,precision:F.RENDERER.PRECISION,logarithmicDepthBuffer:F.RENDERER.LOGARITHMIC_DEPTH_BUFFER,alpha:!1,stencil:!1}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(F.RENDERER.PIXEL_RATIO),this.renderer.physicallyCorrectLights=F.RENDERER.PHYSICALLY_CORRECT_LIGHTS,this.renderer.toneMapping=F.RENDERER.TONE_MAPPING,this.renderer.toneMappingExposure=F.RENDERER.TONE_MAPPING_EXPOSURE,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=n,this.renderer.shadowMap.autoUpdate=!0,this.container.appendChild(this.renderer.domElement),this.renderer.domElement.setAttribute("tabindex","0"),this.renderer.domElement.addEventListener("contextmenu",t=>t.preventDefault())}_setupScene(){this.scene=new a,this.scene.background=new o(657932),this.scene.fog=new r(657932,.002)}_setupCamera(){const t=window.innerWidth/window.innerHeight;this.camera=new h(F.CAMERA.FOV,t,F.CAMERA.NEAR_CLIP,F.CAMERA.FAR_CLIP);const e=F.CAMERA.DEFAULT_POSITION;this.camera.position.set(e[0],e[1],e[2]),this.camera.lookAt(new c(...F.CAMERA.DEFAULT_TARGET))}_setupResizeHandlers(){this.resizeObserver=new ResizeObserver(t=>{for(let e of t)e.target===this.container&&this._onWindowResize(e.contentRect.width,e.contentRect.height)}),this.resizeObserver.observe(this.container),window.addEventListener("orientationchange",()=>{setTimeout(()=>this._onWindowResize(window.innerWidth,window.innerHeight),100)})}_onWindowResize(t,e){this.camera&&this.renderer&&(this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e),this.composer&&this.composer.setSize(t,e),Q.debug("Engine",`Redimensionnement: ${t}x${e}`),tt.emit("engine:resize",{width:t,height:e}))}updateFrustum(){this.camera.updateMatrixWorld(),this.cameraViewProjectionMatrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),this.frustum.setFromProjectionMatrix(this.cameraViewProjectionMatrix)}render(){this.isInitialized&&this.renderer&&this.scene&&this.camera&&(this.composer?this.composer.render():this.renderer.render(this.scene,this.camera))}resize(){this._onWindowResize(window.innerWidth,window.innerHeight)}dispose(){Q.info("Engine","Fermeture et Nettoyage du Moteur 3D..."),this.resizeObserver&&this.resizeObserver.disconnect(),this.renderer&&(this.container.removeChild(this.renderer.domElement),this.renderer.dispose(),this.renderer.forceContextLoss()),this.scene.clear(),this.isInitialized=!1,tt.emit("engine:disposed")}};const st=new class{constructor(){this.isRunning=!1,this.lastTime=0,this.accumulator=0,this.fixedDelta=F.LOOP.PHYSICS_TICK_RATE,this.maxSubSteps=F.LOOP.MAX_SUB_STEPS,this.updateListeners=[],this.renderListeners=[],this.animationFrameId=null,this._loop=this._loop.bind(this)}start(){this.isRunning||(Q.info("Engine","D√©marrage de la Game Loop Utama..."),this.isRunning=!0,this.lastTime=performance.now()/1e3,this.accumulator=0,this.animationFrameId=requestAnimationFrame(this._loop),tt.emit("gameloop:started"))}stop(){this.isRunning&&(Q.info("Engine","Arr√™t de la Game Loop Utama."),this.isRunning=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),tt.emit("gameloop:stopped"))}addUpdate(t,e=10){this._addSorted(this.updateListeners,t,e)}addRender(t,e=10){this._addSorted(this.renderListeners,t,e)}removeUpdate(t){this.updateListeners=this.updateListeners.filter(e=>e.cb!==t)}removeRender(t){this.renderListeners=this.renderListeners.filter(e=>e.cb!==t)}_addSorted(t,e,s){t.find(t=>t.cb===e)||(t.push({cb:e,priority:s}),t.sort((t,e)=>t.priority-e.priority))}_loop(t){if(!this.isRunning)return;this.animationFrameId=requestAnimationFrame(this._loop);const e=t/1e3;let s=e-this.lastTime;this.lastTime=e;const i=this.fixedDelta*this.maxSubSteps;for(s>i&&(Q.warn("Engine",`Chute de framerate d√©tect√©e/Fen√™tre minimis√©e (Delta = ${s.toFixed(3)}s) - Clamping appliqu√©.`),s=i),s*=F.LOOP.TIME_SCALE,this.accumulator+=s;this.accumulator>=this.fixedDelta;)this._runUpdates(this.fixedDelta),this.accumulator-=this.fixedDelta;const n=this.accumulator/this.fixedDelta;tt.processAsync(),this._runRenders(s,n)}_runUpdates(t){for(let s=0;s<this.updateListeners.length;s++)try{this.updateListeners[s].cb(t)}catch(e){Q.error("Engine","Update GameLoop Error",e)}}_runRenders(t,e){for(let i=0;i<this.renderListeners.length;i++)try{this.renderListeners[i].cb(t,e)}catch(s){Q.error("Engine","Render GameLoop Error",s)}}};const it=new class{constructor(){this.currentTimeRaw=H.TIME.START_TIME,this.timeScale=86400/H.TIME.REAL_SECONDS_PER_GAME_DAY,this.timeString="08:00",this.dayCount=1,this.isPaused=!1,this.sunAngle=0,this.isDay=!0}init(){Q.info("World",`TimeManager initialis√©. Ratio: 1s sec temps r√©el = ${this.timeScale.toFixed(2)}s IG`),this.updateTimeStr(),this._calculateSunAngle(),tt.emit("time:initialized",{timeStr:this.timeString,day:this.dayCount,isDay:this.isDay})}update(t){if(this.isPaused)return;const e=t*this.timeScale;this.currentTimeRaw+=e;let s=!1;this.currentTimeRaw>=86400&&(this.currentTimeRaw-=86400,this.dayCount++,s=!0,Q.info("World",`Nouvelle journ√©e in-game : Jour ${this.dayCount}`),tt.emit("time:new_day",{day:this.dayCount}));const i=this.getMinutes();this._calculateSunAngle();(i!==this.getMinutes()||s)&&(this.updateTimeStr(),tt.emit("time:minute_passed",{time:this.currentTimeRaw,str:this.timeString}))}_calculateSunAngle(){const t=this.currentTimeRaw/86400;this.sunAngle=t*Math.PI*2;const e=this.isDay,s=3600*H.TIME.DAWN_START,i=3600*H.TIME.DUSK_START;this.isDay=this.currentTimeRaw>=s&&this.currentTimeRaw<=i,e!==this.isDay&&(this.isDay?(Q.info("World","Le jour se l√®ve sur NeoCity."),tt.emit("time:sunrise")):(Q.info("World","La nuit tombe sur NeoCity."),tt.emit("time:sunset")))}setPaused(t){this.isPaused=t}setTime(t,e){this.currentTimeRaw=3600*t+60*e,this.updateTimeStr(),this._calculateSunAngle(),tt.emit("time:jump",{timeStr:this.timeString,raw:this.currentTimeRaw}),Q.debug("World",`Temps saut√© √† : ${this.timeString}`)}fastForward(t){let e=this.currentTimeRaw+3600*t;for(;e>=86400;)e-=86400,this.dayCount++,tt.emit("time:new_day",{day:this.dayCount});this.currentTimeRaw=e,this.updateTimeStr(),this._calculateSunAngle(),tt.emit("time:fast_forward_complete",{newTime:this.currentTimeRaw})}getHours(){return Math.floor(this.currentTimeRaw/3600)}getMinutes(){return Math.floor(this.currentTimeRaw%3600/60)}updateTimeStr(){const t=String(this.getHours()).padStart(2,"0"),e=String(this.getMinutes()).padStart(2,"0");this.timeString=`${t}:${e}`}getTimeString(){return this.timeString}getSunAngle(){return this.sunAngle}getIsDay(){return this.isDay}getSaveData(){return{timeRaw:this.currentTimeRaw,dayCount:this.dayCount}}loadSaveData(t){t&&(this.currentTimeRaw=t.timeRaw||H.TIME.START_TIME,this.dayCount=t.dayCount||1,this.updateTimeStr(),this._calculateSunAngle())}};const nt=new class{constructor(){this.world=null,this.materials={},this.contactMaterials=[],this.isInitialized=!1,this.bodies=[]}init(){this.isInitialized||(Q.info("Physics","Initialisation du Moteur Physique (Cannon-es)..."),this.world=new T,this.world.gravity.set(O[0],O[1],O[2]),this.world.broadphase=new x(this.world),this.world.solver.iterations=W,this.world.solver.tolerance=G,this.world.allowSleep=!0,this._setupMaterials(),this.isInitialized=!0,Q.info("Physics","Moteur Physique Pr√™t."))}_setupMaterials(){this.materials.default=new k("default"),this.materials.player=new k("player"),this.materials.vehicle=new k("vehicle"),this.materials.ice=new k("ice"),this.materials.bouncy=new k("bouncy"),this.materials.dirt=new k("dirt");const t=$.DEFAULT,e=new C(this.materials.default,this.materials.default,{friction:t.friction,restitution:t.restitution});this.world.addContactMaterial(e);const s=$.PLAYER,i=new C(this.materials.player,this.materials.default,{friction:s.friction,restitution:s.restitution});this.world.addContactMaterial(i);const n=$.VEHICLE,a=new C(this.materials.vehicle,this.materials.default,{friction:n.friction,restitution:n.restitution});this.world.addContactMaterial(a)}update(t){this.world&&this.isInitialized&&this.world.step(t)}addBody(t){this.world&&(this.world.addBody(t),this.bodies.push(t))}removeBody(t){if(!this.world)return;this.world.removeBody(t);const e=this.bodies.indexOf(t);e>-1&&this.bodies.splice(e,1)}raycast(t,e,s={}){const i=new D,n=new B(t,e);B.CLOSEST,void 0!==s.collisionFilterGroup&&(n.collisionFilterGroup=s.collisionFilterGroup),void 0!==s.collisionFilterMask&&(n.collisionFilterMask=s.collisionFilterMask),void 0!==s.skipBackfaces&&(n.skipBackfaces=s.skipBackfaces);return n.intersectWorld(this.world,i)?i:null}raycastAll(t,e,s={}){const i=[],n=new B(t,e);return n.callback=t=>{i.push({body:t.body,shape:t.shape,point:(new N).copy(t.hitPointWorld),normal:(new N).copy(t.hitNormalWorld),distance:t.distance})},n.intersectWorld(this.world,{mode:B.ALL}),i}clear(){Q.info("Physics","Nettoyage du Physics World.");for(let t of this.bodies)this.world.removeBody(t);this.bodies=[]}};const at=new class{constructor(){this.keys=new Map,this.buttons=new Map,this.axes=new Map,this.mouse={x:0,y:0,movementX:0,movementY:0,locked:!1,leftDown:!1,rightDown:!1,scroll:0},this.actions={moveX:0,moveY:0,lookX:0,lookY:0,jump:!1,sprint:!1,crouch:!1,interact:!1,reload:!1,shoot:!1,aim:!1},this.gamepadIndex=null,this.isGamepadActive=!1,this.targetCanvas=null}init(t="game-canvas-container"){const e=document.getElementById(t);this.targetCanvas=e&&e.querySelector("canvas")||window,this._setupKeyboard(),this._setupMouse(),this._setupGamepad()}_setupKeyboard(){window.addEventListener("keydown",t=>{this.keys.get(t.code)||(this.keys.set(t.code,!0),this._checkActionJustPressed(t.code)),this.isGamepadActive=!1}),window.addEventListener("keyup",t=>{this.keys.set(t.code,!1),this.isGamepadActive=!1})}_setupMouse(){document.addEventListener("mousemove",t=>{this.mouse.x=t.clientX,this.mouse.y=t.clientY,this.mouse.locked&&(this.mouse.movementX=t.movementX,this.mouse.movementY=t.movementY),this.isGamepadActive=!1}),document.addEventListener("mousedown",t=>{0===t.button&&(this.mouse.leftDown=!0),2===t.button&&(this.mouse.rightDown=!0),this.isGamepadActive=!1}),document.addEventListener("mouseup",t=>{0===t.button&&(this.mouse.leftDown=!1),2===t.button&&(this.mouse.rightDown=!1),this.isGamepadActive=!1}),document.addEventListener("wheel",t=>{this.mouse.scroll=Math.sign(t.deltaY)},{passive:!0}),document.addEventListener("pointerlockchange",()=>{this.mouse.locked=document.pointerLockElement===this.targetCanvas,tt.emit("input:pointerlock",this.mouse.locked)})}_setupGamepad(){window.addEventListener("gamepadconnected",t=>{this.gamepadIndex=t.gamepad.index,console.log(`Gamepad connect√©: ${t.gamepad.id}`)}),window.addEventListener("gamepaddisconnected",t=>{this.gamepadIndex===t.gamepad.index&&(this.gamepadIndex=null,this.isGamepadActive=!1)})}_checkActionJustPressed(t){const e=V;e.JUMP.includes(t)&&tt.emit("input:action_jump"),e.INTERACT.includes(t)&&tt.emit("input:action_interact"),e.RELOAD.includes(t)&&tt.emit("input:action_reload"),e.OPEN_MOS.includes(t)&&tt.emit("input:action_mos"),e.INVENTORY.includes(t)&&tt.emit("input:action_inventory"),e.SWITCH_CAMERA.includes(t)&&tt.emit("input:action_camera"),e.PAUSE.includes(t)&&tt.emit("input:action_pause")}_isAnyKeyPressed(t){if(!t)return!1;for(let e=0;e<t.length;e++)if(this.keys.get(t[e]))return!0;return!1}_updateGamepad(){if(null===this.gamepadIndex)return;const t=navigator.getGamepads()[this.gamepadIndex];if(!t)return;const e=(t,e=.15)=>Math.abs(t)>e?t:0;if(this.isGamepadActive||(t.axes.some(t=>Math.abs(t)>.2)||t.buttons.some(t=>t.pressed))&&(this.isGamepadActive=!0),this.isGamepadActive){this.axes.set("LeftStickX",e(t.axes[0])),this.axes.set("LeftStickY",e(-t.axes[1])),this.axes.set("RightStickX",e(t.axes[2])),this.axes.set("RightStickY",e(-t.axes[3])),this.axes.set("LeftTrigger",t.buttons[6]?.value||0),this.axes.set("RightTrigger",t.buttons[7]?.value||0);const s=t.buttons,i=new Map;i.set("ButtonS",s[0]?.pressed),i.set("ButtonE",s[1]?.pressed),i.set("ButtonW",s[2]?.pressed),i.set("ButtonN",s[3]?.pressed),!this.buttons.get("ButtonS")&&i.get("ButtonS")&&tt.emit("input:action_jump"),!this.buttons.get("ButtonW")&&i.get("ButtonW")&&tt.emit("input:action_interact"),!this.buttons.get("ButtonN")&&i.get("ButtonN")&&tt.emit("input:action_reload"),this.buttons=i,this.buttons.set("LeftStick",s[10]?.pressed)}}update(){this._updateGamepad();let t=0,e=0,s=0,i=0;const n=V;if(this.isGamepadActive?(t=this.axes.get("LeftStickX")||0,e=this.axes.get("LeftStickY")||0,s=this.axes.get("RightStickX")||0,i=this.axes.get("RightStickY")||0,this.actions.jump=this.buttons.get("ButtonS"),this.actions.crouch=this.buttons.get("ButtonE"),this.actions.sprint=this.buttons.get("LeftStick"),this.actions.aim=this.axes.get("LeftTrigger")>.5,this.actions.shoot=this.axes.get("RightTrigger")>.5):(this._isAnyKeyPressed(n.MOVE_FORWARD)&&(e+=1),this._isAnyKeyPressed(n.MOVE_BACKWARD)&&(e-=1),this._isAnyKeyPressed(n.MOVE_LEFT)&&(t-=1),this._isAnyKeyPressed(n.MOVE_RIGHT)&&(t+=1),this.mouse.locked&&(s=this.mouse.movementX,i=this.mouse.movementY,this.mouse.movementX=0,this.mouse.movementY=0),this.actions.jump=this._isAnyKeyPressed(n.JUMP),this.actions.crouch=this._isAnyKeyPressed(n.CROUCH),this.actions.sprint=this._isAnyKeyPressed(n.SPRINT),this.actions.aim=this.mouse.rightDown,this.actions.shoot=this.mouse.leftDown),!this.isGamepadActive&&(0!==t||0!==e)){const s=Math.sqrt(t*t+e*e);t/=s,e/=s}this.actions.moveX=t,this.actions.moveY=e,this.actions.lookX=s,this.actions.lookY=i,this.mouse.scroll=0}requestPointerLock(){!this.mouse.locked&&this.targetCanvas&&this.targetCanvas.requestPointerLock&&this.targetCanvas.requestPointerLock()}exitPointerLock(){document.pointerLockElement&&document.exitPointerLock()}},ot=(()=>{const t=[{id:"char_hero_base",path:"/assets/models/characters/Hero_Base.glb",processShadows:!0,hasBlendshapes:!0}];["Business","TechWear","StreetGang","Police","Medical"].forEach(e=>{for(let s=1;s<=5;s++)t.push({id:`char_npc_${e.toLowerCase()}_${s}`,path:`/assets/models/characters/NPC_${e}_${s}.glb`,processShadows:!0,hasBlendshapes:!1})});for(let n=1;n<=24;n++){const e=n%4==0?"Glasses_AR":n%4==1?"Bag":n%4==2?"Watch":"Mask";t.push({id:`acc_${e.toLowerCase()}_${n}`,path:`/assets/models/characters/Accessories/${e}_${n}.glb`,processShadows:!0,hasBlendshapes:!1})}const e=[];for(let n=1;n<=15;n++)e.push({id:`veh_sportscar_${n}`,path:`/assets/models/vehicles/SportsCar_${n}.glb`,processShadows:!0,hasBlendshapes:!1});for(let n=1;n<=15;n++)e.push({id:`veh_drone_${n}`,path:`/assets/models/vehicles/Drone_${n}.glb`,processShadows:!0,hasBlendshapes:!1});for(let n=1;n<=10;n++)e.push({id:`veh_heavy_${n}`,path:`/assets/models/vehicles/Heavy_${n}.glb`,processShadows:!0,hasBlendshapes:!1});const s=[];for(let n=1;n<=30;n++)s.push({id:`prop_street_${n}`,path:`/assets/models/buildings/StreetModule_${n}.glb`,processShadows:!0,hasBlendshapes:!1});for(let n=1;n<=40;n++)s.push({id:`bld_structure_${n}`,path:`/assets/models/buildings/Structure_${n}.glb`,processShadows:!0,hasBlendshapes:!1});for(let n=1;n<=30;n++)s.push({id:`prop_interior_${n}`,path:`/assets/models/buildings/InteriorProp_${n}.glb`,processShadows:!0,hasBlendshapes:!1});const i=[];for(let n=1;n<=20;n++)i.push({id:`wep_tactical_${n}`,path:`/assets/models/weapons/Tactical_${n}.glb`,processShadows:!0,hasBlendshapes:!1});return{characters:t,vehicles:e,buildings:s,weapons:i}})(),rt=(()=>{const t=[];for(let s=1;s<=25;s++)t.push({id:`tex_road_${s}`,path:`/assets/textures/environment/Road_${s}.webp`,isColorMap:!0,repeat:!0}),t.push({id:`tex_neon_${s}`,path:`/assets/textures/environment/NeonSign_${s}.webp`,isColorMap:!0,repeat:!1});const e=[];for(let s=1;s<=30;s++)e.push({id:`tex_ui_mos_${s}`,path:`/assets/textures/ui/mOS_Asset_${s}.png`,isColorMap:!0,repeat:!1});return{environment:t,ui:e}})(),ht=(()=>{const t=[];["Combat","CityLife","Vehicles"].forEach(e=>{let s="Combat"===e||"CityLife"===e?30:20;for(let i=1;i<=s;i++)t.push({id:`sfx_${e.toLowerCase()}_${i}`,path:`/assets/audio/sfx/${e}/${e}_${i}.wav`,is3D:!0,loop:!1,baseVolume:1})});const e=[];for(let i=1;i<=10;i++)e.push({id:`amb_soundscape_${i}`,path:`/assets/audio/ambient/Soundscape_${i}.mp3`,is3D:!1,loop:!0,baseVolume:.5});const s=[];for(let i=1;i<=20;i++)s.push({id:`radio_station_${i}`,path:`/assets/audio/radio/Station_${i}.mp3`,is3D:!1,loop:!0,baseVolume:.8});return{sfx:t,ambient:e,radio:s}})();const ct=new class{constructor(){this.manager=new l,this.gltfLoader=new d(this.manager),this.textureLoader=new u(this.manager),this.audioLoader=new m(this.manager),this.fileLoader=new p(this.manager),this.dracoLoader=new y,this.dracoLoader.setDecoderPath("https://www.gstatic.com/draco/versioned/decoders/1.5.6/"),this.gltfLoader.setDRACOLoader(this.dracoLoader),this.cache={models:new Map,textures:new Map,audio:new Map,json:new Map},this._setupManagerEvents()}_setupManagerEvents(){this.manager.onStart=(t,e,s)=>{Q.debug("AssetLoader",`D√©but du chargement: ${t}`)},this.manager.onLoad=()=>{Q.info("AssetLoader","Tous les assets de la file d'attente sont charg√©s !"),tt.emit("assets:queue_complete")},this.manager.onProgress=(t,e,s)=>{const i=e/s;tt.emit("assets:progress",{url:t,progress:i,loaded:e,total:s})},this.manager.onError=t=>{Q.error("AssetLoader",`Erreur lors du chargement de l'asset: ${t}`)}}async loadModel(t,e=!0){if(this.cache.models.has(t)){const s=await this.cache.models.get(t);return this._cloneGLTF(s,e)}const s=new Promise((e,s)=>{this.gltfLoader.load(t,t=>{e(t)},void 0,t=>{s(t)})});this.cache.models.set(t,s);try{const t=await s;return this._cloneGLTF(t,e)}catch(i){throw this.cache.models.delete(t),i}}_cloneGLTF(t,e){const s=t.scene.clone();return s.animations=t.animations,e&&s.traverse(t=>{t.isMesh&&(t.castShadow=!0,t.receiveShadow=!0)}),s}async loadTexture(t,e=!0){if(this.cache.textures.has(t))return this.cache.textures.get(t);const s=new Promise((s,i)=>{this.textureLoader.load(t,t=>{e&&(t.colorSpace=g),t.wrapS=w,t.wrapT=w,s(t)},void 0,t=>i(t))});return this.cache.textures.set(t,s),s}async loadAudio(t){if(this.cache.audio.has(t))return this.cache.audio.get(t);const e=new Promise((e,s)=>{this.audioLoader.load(t,t=>e(t),void 0,t=>s(t))});return this.cache.audio.set(t,e),e}async preloadRegistryAssets(t=["models","textures","audio"]){const e=[];t.includes("models")&&Object.values(ot).forEach(t=>{t.forEach(t=>e.push(this.loadModel(t.path,t.processShadows)))}),t.includes("textures")&&Object.values(rt).forEach(t=>{t.forEach(t=>e.push(this.loadTexture(t.path,t.isColorMap)))}),t.includes("audio")&&Object.values(ht).forEach(t=>{t.forEach(t=>e.push(this.loadAudio(t.path)))}),await Promise.allSettled(e),Q.info("AssetLoader",`Pr√©chargement depuis les registres termin√© (${e.length} items v√©rifi√©s).`)}async loadJSON(t){if(this.cache.json.has(t))return this.cache.json.get(t);const e=new Promise((e,s)=>{this.fileLoader.setResponseType("json"),this.fileLoader.load(t,t=>e(t),void 0,t=>s(t))});return this.cache.json.set(t,e),e}clearCache(){Q.warn("AssetLoader","Purge compl√®te du cache d'assets."),this.cache.models.clear(),this.cache.textures.clear(),this.cache.audio.clear(),this.cache.json.clear()}},lt={TWO_PI:2*Math.PI,HALF_PI:Math.PI/2,QUARTER_PI:Math.PI/4,DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,EPSILON:1e-6,clamp:(t,e,s)=>Math.max(e,Math.min(s,t)),clamp01:t=>Math.max(0,Math.min(1,t)),lerp:(t,e,s)=>t+(e-t)*lt.clamp01(s),lerpUnclamped:(t,e,s)=>t+(e-t)*s,inverseLerp:(t,e,s)=>t!==e?lt.clamp01((s-t)/(e-t)):0,mapRange:(t,e,s,i,n)=>lt.lerp(i,n,lt.inverseLerp(e,s,t)),sign:t=>t>=0?1:-1,approximately:(t,e,s=lt.EPSILON)=>Math.abs(t-e)<s,lerpAngle:(t,e,s)=>{let i=e-t;for(;i<-Math.PI;)i+=lt.TWO_PI;for(;i>Math.PI;)i-=lt.TWO_PI;return t+i*lt.clamp01(s)},deltaAngle:(t,e)=>{let s=e-t;for(;s<-Math.PI;)s+=lt.TWO_PI;for(;s>Math.PI;)s-=lt.TWO_PI;return s},smoothDampAngle:(t,e,s,i,n,a)=>(e=t+lt.deltaAngle(t,e),lt.smoothDamp(t,e,s,i,n,a)),smoothstep:(t,e,s)=>t<=e?0:t>=s?1:(t=(t-e)/(s-e))*t*(3-2*t),smootherstep:(t,e,s)=>t<=e?0:t>=s?1:(t=(t-e)/(s-e))*t*t*(t*(6*t-15)+10),smoothDamp:(t,e,s,i,n,a)=>{const o=2/(i=Math.max(1e-4,i)),r=o*a,h=1/(1+r+.48*r*r+.235*r*r*r);let c=t-e;const l=e,d=n*i;c=lt.clamp(c,-d,d),e=t-c;const u=(s.val+o*c)*a;s.val=(s.val-o*u)*h;let m=e+(c+u)*h;return l-t>0==m>l&&(m=l,s.val=(m-l)/a),m},randRange:(t,e)=>Math.random()*(e-t)+t,randInt:(t,e)=>Math.floor(Math.random()*(e-t+1))+t,randGaussian:(t=0,e=1)=>{let s=Math.random(),i=Math.random();return Math.sqrt(-2*Math.log(s))*Math.cos(lt.TWO_PI*i)*e+t},randElement:t=>t&&0!==t.length?t[Math.floor(Math.random()*t.length)]:null,seededRandom:t=>function(){let e=t+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296},vec3DistanceSq:(t,e,s,i,n,a)=>{const o=i-t,r=n-e,h=a-s;return o*o+r*r+h*h},vec3Distance:(t,e,s,i,n,a)=>Math.sqrt(lt.vec3DistanceSq(t,e,s,i,n,a)),vec2DistanceSq:(t,e,s,i)=>{const n=s-t,a=i-e;return n*n+a*a},vec2Distance:(t,e,s,i)=>Math.sqrt(lt.vec2DistanceSq(t,e,s,i)),_noiseGen:{PERLIN_YWRAPB:4,PERLIN_YWRAP:16,PERLIN_ZWRAPB:8,PERLIN_ZWRAP:256,PERLIN_SIZE:4095,perlin_octaves:4,perlin_amp_falloff:.5,perlin:null},noiseSeed:t=>{const e=()=>{let e=4294967296;return(t=(1664525*t+1013904223)%e)/e};lt._noiseGen.perlin=new Array(lt._noiseGen.PERLIN_SIZE+1);for(let s=0;s<lt._noiseGen.PERLIN_SIZE+1;s++)lt._noiseGen.perlin[s]=e()},noise:(t,e=0,s=0)=>{const i=lt._noiseGen;null===i.perlin&&lt.noiseSeed(Math.random()),t<0&&(t=-t),e<0&&(e=-e),s<0&&(s=-s);let n,a,o,r,h,c=Math.floor(t),l=Math.floor(e),d=Math.floor(s),u=t-c,m=e-l,p=s-d,y=0,g=.5;for(let w=0;w<i.perlin_octaves;w++){let t=c+(l<<i.PERLIN_YWRAPB)+(d<<i.PERLIN_ZWRAPB);n=lt.smoothstep(u,0,1),a=lt.smoothstep(m,0,1),o=i.perlin[t&i.PERLIN_SIZE],o+=n*(i.perlin[t+1&i.PERLIN_SIZE]-o),r=i.perlin[t+i.PERLIN_YWRAP&i.PERLIN_SIZE],r+=n*(i.perlin[t+i.PERLIN_YWRAP+1&i.PERLIN_SIZE]-r),o+=a*(r-o),t+=i.PERLIN_ZWRAP,r=i.perlin[t&i.PERLIN_SIZE],r+=n*(i.perlin[t+1&i.PERLIN_SIZE]-r),h=i.perlin[t+i.PERLIN_YWRAP&i.PERLIN_SIZE],h+=n*(i.perlin[t+i.PERLIN_YWRAP+1&i.PERLIN_SIZE]-h),r+=a*(h-r),o+=lt.smoothstep(p,0,1)*(r-o),y+=o*g,g*=i.perlin_amp_falloff,c<<=1,u*=2,l<<=1,m*=2,d<<=1,p*=2,u>=1&&(c++,u--),m>=1&&(l++,m--),p>=1&&(d++,p--)}return y}};const dt=new class{constructor(){this.camera=null,this.target=null,this.mode="TPS",this.pivot=new _,this.currentPosition=new c,this.currentLookAt=new c,this.velocityPos={val:new c},this.velocityLook={val:new c},this.cameraShake=new c,this.shakeTime=0,this.shakeIntensity=0,this.isAiming=!1,this.baseFov=75,this.aimFov=50,this.currentFov=75}init(){this.camera=et.camera,this.baseFov=this.camera.fov,this.pivot.add(this.camera)}setTarget(t){this.target=t}setMode(t){"FPS"!==t&&"TPS"!==t||(this.mode=t)}toggleMode(){this.mode="TPS"===this.mode?"FPS":"TPS"}setAiming(t){this.isAiming=t}addShake(t,e){this.shakeIntensity=Math.max(this.shakeIntensity,t),this.shakeTime=Math.max(this.shakeTime,e)}update(t){if(!this.target||!this.camera)return;const e=this.isAiming?this.aimFov:this.baseFov;this.currentFov=lt.lerp(this.currentFov,e,10*t),Math.abs(this.camera.fov-this.currentFov)>.1&&(this.camera.fov=this.currentFov,this.camera.updateProjectionMatrix());let s=new c(0,0,0);if(this.shakeTime>0){this.shakeTime-=t;const e=this.shakeTime>0?this.shakeTime:0,i=(2*Math.random()-1)*this.shakeIntensity*e,n=(2*Math.random()-1)*this.shakeIntensity*e;s.set(i,n,0),this.shakeTime<=0&&(this.shakeIntensity=0)}let i=new c;if(new c,"TPS"===this.mode){const t=this.isAiming?z.CAMERA.TPS_OFFSET_AIM:z.CAMERA.TPS_OFFSET;i.copy(this.target.position),i.y+=t[1]}else if("FPS"===this.mode){const t=z.CAMERA.FPS_OFFSET;i.copy(this.target.position),i.add(new c(t[0],t[1],t[2]))}this.camera.position.add(s)}};const ut=new class{constructor(){this.db=null,this.dbName=U,this.dbVersion=q,this.stores=Y}init(){return new Promise((t,e)=>{if(!window.indexedDB)return Q.fatal("SaveSys","Votre navigateur ne supporte pas IndexedDB. Sauvegardes impossibles."),void e(new Error("IndexedDB not supported"));const s=window.indexedDB.open(this.dbName,this.dbVersion);s.onerror=t=>{Q.error("SaveSys","Erreur ouverture DB",t.target.error),e(t.target.error)},s.onsuccess=e=>{this.db=e.target.result,Q.info("SaveSys",`Connect√© √† la base locale v${this.dbVersion}`),t(!0)},s.onupgradeneeded=t=>{const e=t.target.result;Q.info("SaveSys","Upgrade requis. Cr√©ation des ObjectStores..."),this.stores.forEach(t=>{e.objectStoreNames.contains(t)||e.createObjectStore(t,{keyPath:"id"})})}})}saveData(t,e,s){return new Promise((i,n)=>{if(!this.db)return n(new Error("Base de donn√©es non initialis√©e"));if(!this.stores.includes(t))return n(new Error(`Store invalide: ${t}`));const a=this.db.transaction([t],"readwrite").objectStore(t),o={...s,id:e,lastUpdated:Date.now()},r=a.put(o);r.onsuccess=()=>i(),r.onerror=s=>{Q.error("SaveSys",`Erreur sauvegarde [${t} : ${e}]`,s.target.error),n(s.target.error)}})}loadData(t,e){return new Promise((s,i)=>{if(!this.db)return i(new Error("Base de donn√©es non initialis√©e"));const n=this.db.transaction([t],"readonly").objectStore(t).get(e);n.onsuccess=t=>{t.target.result?s(t.target.result):s(null)},n.onerror=t=>i(t.target.error)})}getAllKeys(t){return new Promise((e,s)=>{if(!this.db)return s(new Error("DB non initiale"));const i=this.db.transaction([t],"readonly").objectStore(t).getAllKeys();i.onsuccess=t=>e(t.target.result),i.onerror=t=>s(t.target.error)})}deleteData(t,e){return new Promise((s,i)=>{if(!this.db)return i(new Error("DB non initiale"));const n=this.db.transaction([t],"readwrite").objectStore(t).delete(e);n.onsuccess=()=>s(),n.onerror=t=>i(t.target.error)})}async saveCompoundState(t,e){Q.info("SaveSys",`Enregistrement global sur [${t}]...`);try{const s=[];for(const[i,n]of Object.entries(e))this.stores.includes(i)&&s.push(this.saveData(i,t,n));return await Promise.all(s),Q.info("SaveSys",`Jeu sauv√© avec succ√®s sur le slot [${t}]`),!0}catch(s){return Q.error("SaveSys","√âchec critique durant Compound Save",s),!1}}async loadCompoundState(t){Q.info("SaveSys",`Chargement global depuis [${t}]...`);try{const e={},s=this.stores.map(async s=>{const i=await this.loadData(s,t);i&&(e[s]=i)});return await Promise.all(s),e}catch(e){return Q.error("SaveSys","√âchec critique durant Compound Load",e),null}}};const mt=new class{constructor(){this.baseLayer=null,this.activeMenu=null,this.hudInstance=null,this.menus=new Map,this.isInitialized=!1,this.isInputBlockedByUI=!1}init(){this.isInitialized||(this.baseLayer=document.getElementById("ui-layer"),this.baseLayer?(this._setupInputListeners(),tt.on("ui:show_notification",this.showNotification.bind(this)),this.isInitialized=!0,Q.info("UI","UIManager Controller Initialis√©.")):Q.fatal("UI","Impossible de trouver #ui-layer dans index.html"))}_setupInputListeners(){tt.on("input:action_pause",()=>{this.activeMenu&&"pause"!==this.activeMenu.id?this.closeMenu():this.activeMenu&&"pause"===this.activeMenu.id?(this.closeMenu(),tt.emit("gameloop:resume")):(this.openMenu("pause"),tt.emit("gameloop:pause"))})}registerMenu(t,e){this.menus.set(t,e)}registerHUD(t){this.hudInstance=t}openMenu(t,e=null){this.menus.has(t)?(this.activeMenu&&this.activeMenu.hide(),this.activeMenu=this.menus.get(t),at.exitPointerLock(),this.isInputBlockedByUI=!0,this.baseLayer.classList.add("menu-open"),this.activeMenu.show(e),tt.emit("ui:menu_opened",t),Q.debug("UI",`Menu Ouvert: ${t}`)):Q.error("UI",`Tentative d'ouverture d'un menu inconnu: ${t}`)}closeMenu(){if(!this.activeMenu)return;const t=this.activeMenu.id;this.activeMenu.hide(),this.activeMenu=null,this.baseLayer.classList.remove("menu-open"),this.isInputBlockedByUI=!1,"main"!==t&&at.requestPointerLock(),tt.emit("ui:menu_closed",t),Q.debug("UI",`Menu Ferm√©: ${t}`)}toggleHUD(t){this.hudInstance&&(t?this.hudInstance.show():this.hudInstance.hide())}showNotification({title:t,message:e,type:s="info",duration:i=4e3}){let n=document.getElementById("notif-container");n||(n=document.createElement("div"),n.id="notif-container",this.baseLayer.appendChild(n));const a=document.createElement("div");a.className=`toast-notif toast-${s}`;const o=document.createElement("div");o.className="scanline",o.style.cssText="position:absolute;inset:0;opacity:0.2;pointer-events:none;",a.appendChild(o);const r=document.createElement("div");r.style.cssText="position:relative;z-index:1;",r.innerHTML=`\n            <span class="toast-title">${t}</span>\n            <span class="toast-message">${e}</span>\n        `,a.appendChild(r),n.appendChild(a),requestAnimationFrame(()=>{requestAnimationFrame(()=>a.classList.add("toast-in"))}),setTimeout(()=>{a.classList.remove("toast-in"),a.classList.add("toast-out"),setTimeout(()=>a.parentNode&&a.parentNode.removeChild(a),500)},i)}hideBootScreen(){const t=document.getElementById("boot-screen");t&&(t.style.opacity="0",setTimeout(()=>{t.style.display="none"},1e3))}};const pt=new class{constructor(){this.scene=null,this.worldGroup=new f,this.chunks=new Map,this.currentChunkId=null,this.renderDistance=H.RENDER_DISTANCE,this.chunkSize=H.CHUNK_SIZE,this.skyMaterial=null,this.sunLight=null,this.ambientLight=null,this.moonLight=null,this.isInitialized=!1}init(){this.isInitialized||(this.scene=et.scene,this.scene.add(this.worldGroup),this._setupLighting(),this._setupSky(),this._setupFog(),this._setupBaseGround(),this.isInitialized=!0,Q.info("World","World System Initialis√©."))}_setupLighting(){this.ambientLight=new v(659752,.2),this.scene.add(this.ambientLight),this.sunLight=new E(16773341,2),this.sunLight.castShadow=!0,this.sunLight.shadow.mapSize.width=4096,this.sunLight.shadow.mapSize.height=4096,this.sunLight.shadow.camera.near=1,this.sunLight.shadow.camera.far=1e3;const t=200;this.sunLight.shadow.camera.left=-t,this.sunLight.shadow.camera.right=t,this.sunLight.shadow.camera.top=t,this.sunLight.shadow.camera.bottom=-t,this.sunLight.shadow.bias=-5e-4,this.sunLight.position.set(100,200,50),this.scene.add(this.sunLight),this.moonLight=new E(8961023,0),this.moonLight.position.set(-100,-200,-50),this.scene.add(this.moonLight)}_setupSky(){this.scene.background=new o(8900331)}_setupFog(){this.scene.fog=new r(8900331,.002)}_setupBaseGround(){const t=new S(1e4,1e4),e=new b({color:1118481,roughness:.8,metalness:.2}),s=new M(t,e);s.rotation.x=-Math.PI/2,s.receiveShadow=!0,this.worldGroup.add(s);const i=new nt.cannon.Plane,n=new nt.cannon.Body({mass:0});n.addShape(i),n.quaternion.setFromEuler(-Math.PI/2,0,0),nt.world.addBody(n)}updateTimeOfDay(t,e){if(!this.sunLight)return;const s=500;this.sunLight.position.x=Math.cos(t)*s,this.sunLight.position.y=Math.sin(t)*s,this.sunLight.position.z=Math.cos(t)*s*.5,this.moonLight.position.x=-this.sunLight.position.x,this.moonLight.position.y=-this.sunLight.position.y,this.moonLight.position.z=-this.sunLight.position.z;const i=Math.max(0,this.sunLight.position.y/s),n=Math.max(0,this.moonLight.position.y/s);let a=3*Math.pow(i,.5),r=.5*Math.pow(n,.5),h=!1;(e>=5&&e<=7||e>=18&&e<=20)&&(h=!0);let c=new o(16777215),l=new o(8900331),d=new o(4210752);h?(c.setHex(16742195),l.setHex(16755336),d.setHex(3351074)):0===i?(c.setHex(0),l.setHex(330261),d.setHex(659752)):(c.setHex(16774630),l.setHex(8900331),d.setHex(6316128)),this.sunLight.color.lerp(c,.05),this.scene.fog.color.lerp(l,.05),this.scene.background.lerp(l,.05),this.ambientLight.color.lerp(d,.05),this.sunLight.intensity=lt.lerp(this.sunLight.intensity,a,.1),this.moonLight.intensity=lt.lerp(this.moonLight.intensity,r,.1)}updateStreaming(t){const e=Math.floor(t.x/this.chunkSize),s=Math.floor(t.z/this.chunkSize),i=`${e}_${s}`;this.currentChunkId!==i&&(this.currentChunkId=i,this._loadChunksAround(e,s))}_loadChunksAround(t,e){const s=new Set,i=this.renderDistance;for(let n=t-i;n<=t+i;n++)for(let a=e-i;a<=e+i;a++)Math.hypot(n-t,a-e)<=i&&s.add(`${n}_${a}`);for(const[n,a]of this.chunks.entries())s.has(n)||this._unloadChunk(n);for(const n of s)if(!this.chunks.has(n)){const[t,e]=n.split("_").map(Number);this._loadChunk(n,t,e)}}_loadChunk(t,e,s){this.chunks.set(t,{loaded:!1,group:new f,bodies:[]})}_unloadChunk(t){const e=this.chunks.get(t);e&&(this.worldGroup.remove(e.group),e.bodies.forEach(t=>nt.world.removeBody(t)),this.chunks.delete(t))}};class yt{constructor(){this.mesh=null,this.physicsBody=null,this.velocity=new c,this.direction=new c,this.euler=new R(0,0,0,"YXZ"),this.isGrounded=!1,this.isSprinting=!1,this.isCrouching=!1,this.jumpTimer=0}init(t){const e=z.PHYSICS.HEIGHT,s=z.PHYSICS.RADIUS,i=new I(s,e-2*s,4,8),n=new b({color:4474026});this.mesh=new M(i,n),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,et.scene.add(this.mesh);const a=new nt.cannon.Sphere(s);this.physicsBody=new nt.cannon.Body({mass:z.PHYSICS.MASS,material:nt.materials.player,fixedRotation:!0,linearDamping:.9}),this.physicsBody.addShape(a,new nt.cannon.Vec3(0,-e/2+s,0));const o=new nt.cannon.Sphere(s);this.physicsBody.addShape(o,new nt.cannon.Vec3(0,e/2-s,0)),this.physicsBody.position.copy(t),nt.world.addBody(this.physicsBody),dt.setTarget(this.mesh)}update(t){this.physicsBody&&(this.mesh.position.copy(this.physicsBody.position),this._updateRotation(),this._checkGrounded(),this._updateMovement(t),dt.update(t))}_updateRotation(){const t=z.CAMERA.SENSITIVITY_X,e=z.CAMERA.SENSITIVITY_Y;this.euler.y-=at.actions.lookX*t,this.euler.x-=at.actions.lookY*e,this.euler.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,this.euler.x)),this.mesh.quaternion.setFromEuler(new R(0,this.euler.y,0)),dt.camera.quaternion.setFromEuler(this.euler)}_checkGrounded(){const t=(new nt.cannon.Vec3).copy(this.physicsBody.position);new nt.cannon.Vec3(t.x,t.y-z.PHYSICS.HEIGHT/2-.2,t.z),this.isGrounded=Math.abs(this.physicsBody.velocity.y)<.1}_updateMovement(t){this.jumpTimer>0&&(this.jumpTimer-=t);let e=z.MOVEMENT.WALK_SPEED;at.actions.crouch?(e=z.MOVEMENT.CROUCH_SPEED,this.isCrouching=!0,this.isSprinting=!1):at.actions.sprint?(e=z.MOVEMENT.RUN_SPEED,this.isSprinting=!0,this.isCrouching=!1):(this.isSprinting=!1,this.isCrouching=!1),at.actions.jump&&this.isGrounded&&this.jumpTimer<=0&&(this.physicsBody.velocity.y=Math.sqrt(19.62*z.MOVEMENT.JUMP_FORCE),this.jumpTimer=.5,this.isGrounded=!1);const s=new c(0,0,-1).applyQuaternion((new L).setFromEuler(new R(0,this.euler.y,0))),i=new c(1,0,0).applyQuaternion((new L).setFromEuler(new R(0,this.euler.y,0)));if(s.multiplyScalar(-at.actions.moveY),i.multiplyScalar(at.actions.moveX),this.direction.addVectors(s,i).normalize(),this.direction.lengthSq()>0){const s=this.direction.x*e,i=this.direction.z*e;this.isGrounded?(this.physicsBody.velocity.x+=10*(s-this.physicsBody.velocity.x)*t,this.physicsBody.velocity.z+=10*(i-this.physicsBody.velocity.z)*t):(this.physicsBody.velocity.x+=2*(s-this.physicsBody.velocity.x)*t,this.physicsBody.velocity.z+=2*(i-this.physicsBody.velocity.z)*t)}this.isCrouching?(this.mesh.scale.y=.5,this.physicsBody.shapes[1].offset.y=0):(this.mesh.scale.y=1,this.physicsBody.shapes[1].offset.y=z.PHYSICS.HEIGHT/2-z.PHYSICS.RADIUS)}getPosition(){return this.physicsBody?this.physicsBody.position:{x:0,y:0,z:0}}setPosition(t){this.physicsBody&&(this.physicsBody.position.copy(t),this.physicsBody.velocity.set(0,0,0))}}class gt{constructor(){this.maxHealth=z.RPG.MAX_HEALTH,this.health=this.maxHealth,this.healthRegenTime=0,this.maxStamina=100,this.stamina=this.maxStamina,this.attributes={strength:5,agility:5,intelligence:5,charisma:5},this.level=1,this.xp=0}init(){this._notifyHealth(),this._notifyStamina()}update(t){this.stamina<this.maxStamina&&(this.stamina+=5*t,this.stamina>this.maxStamina&&(this.stamina=this.maxStamina),this._notifyStamina()),this.health<this.maxHealth&&this.healthRegenTime>5?(this.health+=2*t,this.health>this.maxHealth&&(this.health=this.maxHealth),this._notifyHealth()):this.healthRegenTime+=t}applyDamage(t){t<=0||this.health<=0||(this.health-=t,this.healthRegenTime=0,this.health<=0&&(this.health=0,this.die()),this._notifyHealth(),tt.emit("player:damaged",t))}heal(t){t<=0||this.health>=this.maxHealth||(this.health=Math.min(this.health+t,this.maxHealth),this._notifyHealth())}consumeStamina(t){return this.stamina>=t&&(this.stamina-=t,this._notifyStamina(),!0)}die(){tt.emit("player:died"),console.log("MORT DU JOUEUR (Wasted)")}_notifyHealth(){tt.emit("player:health_changed",{current:this.health,max:this.maxHealth})}_notifyStamina(){tt.emit("player:stamina_changed",{current:this.stamina,max:this.maxStamina})}serialize(){return{health:this.health,stamina:this.stamina,attributes:this.attributes,level:this.level,xp:this.xp}}deserialize(t){t&&(this.health=t.health||this.maxHealth,this.stamina=t.stamina||this.maxStamina,this.attributes=t.attributes||this.attributes,this.level=t.level||1,this.xp=t.xp||0,this._notifyHealth(),this._notifyStamina())}}class wt{constructor(){this.hunger=100,this.thirst=100,this.energy=100,this.decayRates={hunger:.05,thirst:.1,energy:.02}}init(){}update(t){this.hunger=Math.max(0,this.hunger-this.decayRates.hunger*t),this.thirst=Math.max(0,this.thirst-this.decayRates.thirst*t),this.energy=Math.max(0,this.energy-this.decayRates.energy*t),0!==this.hunger&&0!==this.thirst||tt.emit("player:starving_damage",1),this.energy<20&&tt.emit("player:exhausted")}eat(t){this.hunger=Math.min(100,this.hunger+t),tt.emit("player:survival_updated",this.serialize())}drink(t){this.thirst=Math.min(100,this.thirst+t),tt.emit("player:survival_updated",this.serialize())}sleep(t){this.energy=Math.min(100,this.energy+12*t),tt.emit("player:survival_updated",this.serialize())}serialize(){return{hunger:this.hunger,thirst:this.thirst,energy:this.energy}}deserialize(t){t&&(this.hunger=t.hunger,this.thirst=t.thirst,this.energy=t.energy)}}const _t=[{id:"item_food_burger",name:"Neo-Burger Synth√©tique",type:"consumable",category:"food",description:"Un burger classique de NeoCity, compos√© √† 90% de prot√©ines de synth√®se.",weight:.2,price:15,effects:{hunger:35,health:5,thirst:-5},maxStack:10,model:"models/items/food_burger.glb",icon:"üçî"},{id:"item_drink_cola",name:"Nuka-Kola Quantum",type:"consumable",category:"drink",description:"Boisson hautement caf√©in√©e et l√©g√®rement radioactive.",weight:.3,price:8,effects:{thirst:40,stamina:20,health:-2},maxStack:15,model:"models/items/drink_cola.glb",icon:"ü•§"},{id:"item_med_stimpack",name:"Stimpack Militaire Mk-II",type:"consumable",category:"medicine",description:"Injecteur automatique contenant des nanobots r√©g√©n√©rateurs.",weight:.1,price:250,effects:{health:75,stamina:50},maxStack:5,model:"models/items/med_stimpack.glb",icon:"üíâ"},{id:"item_weap_pistol_9mm",name:"Vindicator 9mm",type:"weapon",category:"firearm",description:"Pistolet semi-automatique fiable, l'arme de poing standard de NeoCity.",weight:1.2,price:850,stats:{damage:25,fireRate:400,magazineSize:12,reloadTime:1.5,range:50,recoil:.5},ammoType:"ammo_9mm",maxStack:1,model:"models/weapons/pistol_9mm.glb",icon:"üî´"},{id:"item_weap_rifle_ar",name:"Fusil d'Assaut K-47",type:"weapon",category:"firearm",description:"Arme automatique √† forte cadence de tir. Ill√©gal sans permis corporatiste.",weight:3.8,price:3500,stats:{damage:32,fireRate:600,magazineSize:30,reloadTime:2.2,range:150,recoil:1.2},ammoType:"ammo_556mm",maxStack:1,model:"models/weapons/rifle_ar.glb",icon:"üß®"},{id:"item_ammo_9mm",name:"Munitions 9mm",type:"ammo",category:"ammo",description:"Bo√Æte de munitions standard pour pistolets et SMGs.",weight:.01,price:2,maxStack:240,model:"models/items/ammo_box_small.glb",icon:"üõ°Ô∏è"},{id:"item_misc_phone",name:"mPhone Pro Max",type:"utility",category:"electronics",description:"Terminal de communication principal. Permet l'acc√®s au mOS.",weight:.15,price:1200,maxStack:1,model:"models/items/mphone.glb",icon:"üì±"},{id:"item_junk_scrap",name:"D√©bris √âlectroniques",type:"material",category:"junk",description:"Composants r√©cup√©r√©s sur de vieux terminaux. Utilis√©s pour le craft.",weight:.5,price:15,maxStack:100,model:"models/items/junk_scrap.glb",icon:"‚öôÔ∏è"},{id:"item_tool_lockpick",name:"Passe-partout √âlectronique",type:"tool",category:"illegal",description:"Appareil permettant de contourner les serrures magn√©tiques bas de gamme.",weight:.2,price:500,maxStack:5,durability:3,model:"models/items/tool_lockpick.glb",icon:"üîì"},{id:"item_apparel_jacket",name:"Veste en Cuir Renforc√©e",type:"apparel",category:"clothing",description:"Veste offrant une l√©g√®re protection balistique.",weight:2.5,price:450,stats:{armor:15,stealth:-2},equipSlot:"torso",maxStack:1,model:"models/apparel/jacket_leather.glb",icon:"üß•"}];class ft{constructor(){this.maxWeight=30,this.currentWeight=0,this.items=[],this.weapons=[null,null,null],this.activeWeaponIndex=-1}init(){}addItem(t,e=1){const s=_t.find(e=>e.id===t);if(!s)return!1;const i=s.weight*e;if(this.currentWeight+i>this.maxWeight)return tt.emit("ui:show_notification",{title:"INVENTORY",message:"Too heavy to carry!",type:"error"}),!1;const n=this.items.find(e=>e.id===t);return n&&"Weapon"!==s.category?n.qty+=e:this.items.push({id:t,qty:e}),this._recalcWeight(),tt.emit("inventory:added",{id:t,amount:e}),!0}removeItem(t,e=1){const s=this.items.findIndex(e=>e.id===t);return s>-1&&(this.items[s].qty-=e,this.items[s].qty<=0&&this.items.splice(s,1),this._recalcWeight(),tt.emit("inventory:removed",{id:t,amount:e}),!0)}_recalcWeight(){this.currentWeight=0,this.items.forEach(t=>{const e=_t.find(e=>e.id===t.id);e&&(this.currentWeight+=e.weight*t.qty)})}equipWeapon(t,e){const s=this.items[t],i=_t.find(t=>t.id===s.id);i&&"Weapon"===i.category&&(this.weapons[e]=s,this.items.splice(t,1))}drawWeapon(t){if(this.weapons[t]){this.activeWeaponIndex=t;const e=_t.find(e=>e.id===this.weapons[t].id);tt.emit("player:weapon_equipped",{name:e.name,clip:12,reserve:48})}}holsterWeapon(){this.activeWeaponIndex=-1,tt.emit("player:weapon_equipped",null)}serialize(){return{maxWeight:this.maxWeight,items:this.items,weapons:this.weapons}}deserialize(t){t&&(this.maxWeight=t.maxWeight||30,this.items=t.items||[],this.weapons=t.weapons||[null,null,null],this._recalcWeight())}}const vt=new class{constructor(){this.alias="V",this.background="streetkid",this.controller=new yt,this.stats=new gt,this.survival=new wt,this.inventory=new ft,this.money=0,this.wantedLevel=0}init(t=new c(0,5,0)){this.controller.init(t),this.stats.init(),this.survival.init(),this.inventory.init(),this._setupEvents()}_setupEvents(){tt.on("economy:add_money",t=>this.addMoney(t)),tt.on("economy:remove_money",t=>this.removeMoney(t)),tt.on("game:request_save",()=>this.saveData()),tt.on("game:request_load",()=>this.loadData())}update(t){this.controller.update(t),this.stats.update(t),this.survival.update(t)}setIdentity(t,e,s){this.alias=t,this.background=e,this.money=s,tt.emit("player:money_changed",this.money)}addMoney(t){t<=0||(this.money+=t,tt.emit("player:money_changed",this.money),tt.emit("ui:show_notification",{title:"FUNDS RECEIVED",message:`+‚Ç¨$${t.toLocaleString()}`,type:"money"}))}removeMoney(t){return!(t<=0)&&(this.money>=t?(this.money-=t,tt.emit("player:money_changed",this.money),!0):(tt.emit("ui:show_notification",{title:"TRANSACTION FAILED",message:"Insufficient Funds",type:"error"}),!1))}async saveData(){const t={alias:this.alias,background:this.background,money:this.money,wantedLevel:this.wantedLevel,position:this.controller.getPosition(),stats:this.stats.serialize(),survival:this.survival.serialize(),inventory:this.inventory.serialize()};await ut.saveData("player","current_save",t)}async loadData(){const t=await ut.loadData("player","current_save");t&&(this.alias=t.alias,this.background=t.background,this.money=t.money,this.wantedLevel=t.wantedLevel,this.controller.setPosition(t.position),this.stats.deserialize(t.stats),this.survival.deserialize(t.survival),this.inventory.deserialize(t.inventory),tt.emit("player:money_changed",this.money))}};class Et{constructor(t){this.npc=t,this.currentState="WANDER",this.walkSpeed=2,this.runSpeed=6,this.targetPoint=new c,this.timeInState=0,this._pickNewWanderPoint()}update(t){switch(this.timeInState+=t,this.currentState){case"IDLE":this._handleIdle(t);break;case"WANDER":this._handleWander(t);break;case"FLEE":this._handleFlee(t);break;case"COMBAT":this._handleCombat(t)}}_handleIdle(t){this.npc.body.velocity.x*=.9,this.npc.body.velocity.z*=.9,this.timeInState>3+5*Math.random()&&this.setState("WANDER")}_handleWander(t){const e=this.npc.body.position,s=this.targetPoint.x-e.x,i=this.targetPoint.z-e.z,n=s*s+i*i;if(n<1)return void this.setState("IDLE");const a=Math.sqrt(n),o=s/a,r=i/a;this.npc.body.velocity.x=o*this.walkSpeed,this.npc.body.velocity.z=r*this.walkSpeed,this.timeInState>15&&this.setState("IDLE")}_handleFlee(t){this.npc.body.velocity.x=Math.sin(this.timeInState)*this.runSpeed,this.npc.body.velocity.z=Math.cos(this.timeInState)*this.runSpeed,this.timeInState>10&&this.setState("WANDER")}_handleCombat(t){this.npc.body.velocity.x*=.5,this.npc.body.velocity.z*=.5}_pickNewWanderPoint(){const t=Math.random()*Math.PI*2,e=20*Math.random();this.targetPoint.set(this.npc.body.position.x+Math.cos(t)*e,this.npc.body.position.y,this.npc.body.position.z+Math.sin(t)*e)}setState(t){this.currentState!==t&&(this.currentState=t,this.timeInState=0,"WANDER"===t&&this._pickNewWanderPoint())}onDamaged(){"civilian"===this.npc.type||"corpo"===this.npc.type?this.setState("FLEE"):this.setState("COMBAT")}}class St{constructor(t,e="civilian",s=new c){this.id=t,this.type=e,this.mesh=null,this.body=null,this.brain=new Et(this),this.health=100,this.isDead=!1,this._spawn(s)}_spawn(t){const e=new P(.4,.4,1.8,8);e.translate(0,.9,0);let s=8947848;"police"===this.type?s=255:"gang"===this.type?s=16711680:"corpo"===this.type&&(s=2236962);const i=new b({color:s});this.mesh=new M(e,i),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,et.scene.add(this.mesh);const n=new nt.cannon.Cylinder(.4,.4,1.8,8),a=new nt.cannon.Quaternion;a.setFromAxisAngle(new nt.cannon.Vec3(1,0,0),-Math.PI/2),this.body=new nt.cannon.Body({mass:70,fixedRotation:!0,position:new nt.cannon.Vec3(t.x,t.y,t.z)}),this.body.addShape(n,new nt.cannon.Vec3(0,.9,0),a),nt.world.addBody(this.body)}update(t){if(!this.isDead&&(this.brain.update(t),this.mesh.position.copy(this.body.position),this.body.velocity.lengthSq()>.1)){const t=Math.atan2(this.body.velocity.x,this.body.velocity.z);this.mesh.rotation.y=t}}applyDamage(t){this.isDead||(this.health-=t,this.health<=0?this.die():this.brain.onDamaged())}die(){this.isDead=!0,this.body.fixedRotation=!1}destroy(){et.scene.remove(this.mesh),nt.world.removeBody(this.body)}}const bt=new class{constructor(){this.activeNPCs=[],this.maxPoolSize=50,this.spawnRadius=100,this.despawnRadius=150}init(){}update(t,e){for(let s=this.activeNPCs.length-1;s>=0;s--){const i=this.activeNPCs[s];i.update(t);this._distSq(e,i.body.position)>this.despawnRadius*this.despawnRadius&&this._despawnNPC(s)}Math.random()>.9&&this.activeNPCs.length<this.maxPoolSize&&this._spawnRandomNPC(e)}_spawnRandomNPC(t){const e=Math.random()*Math.PI*2,s=t.x+Math.cos(e)*this.spawnRadius,i=t.z+Math.sin(e)*this.spawnRadius,n=Math.random();let a="civilian";n>.8&&(a="gang"),n>.9&&(a="police"),n>.95&&(a="corpo");const o=new St(`npc_${Date.now()}_${Math.random()}`,a,new c(s,5,i));this.activeNPCs.push(o)}_despawnNPC(t){this.activeNPCs[t].destroy(),this.activeNPCs.splice(t,1)}_distSq(t,e){const s=t.x-e.x,i=t.y-e.y,n=t.z-e.z;return s*s+i*i+n*n}};class Mt{constructor(t,e={w:2,h:1,d:4},s=new c(0,2,0)){this.chassisBody=null,this.vehicle=null,this.wheelBodies=[],this.wheelMeshes=[],this._setupPhysics(t,e,s)}_setupPhysics(t,e,s){const i=new nt.cannon.Box(new nt.cannon.Vec3(e.w/2,e.h/2,e.d/2));this.chassisBody=new nt.cannon.Body({mass:t,material:nt.materials.vehicle}),this.chassisBody.addShape(i),this.chassisBody.position.copy(s),this.chassisBody.position.y+=.5,this.vehicle=new nt.cannon.RaycastVehicle({chassisBody:this.chassisBody,indexRightAxis:0,indexUpAxis:1,indexForwardAxis:2}),this.wheelOptions={radius:.4,directionLocal:new nt.cannon.Vec3(0,-1,0),suspensionStiffness:30,suspensionRestLength:.4,frictionSlip:5,dampingRelaxation:2.3,dampingCompression:4.4,maxSuspensionForce:1e5,rollInfluence:.1,axleLocal:new nt.cannon.Vec3(1,0,0),chassisConnectionPointLocal:new nt.cannon.Vec3(1,1,0),maxSuspensionTravel:.3,customSlidingRotationalSpeed:-30,useCustomSlidingRotationalSpeed:!0},this.vehicle.addToWorld(nt.world)}addWheel(t,e,s,i,n={}){const a={...this.wheelOptions,...n};a.chassisConnectionPointLocal.set(t,e,s),this.vehicle.addWheel(a);const o=new nt.cannon.Body({mass:0,type:nt.cannon.Body.KINEMATIC});o.collisionFilterGroup=0,this.wheelBodies.push(o),nt.world.addBody(o)}applyEngineForce(t,e){this.vehicle.applyEngineForce(t,e)}setSteeringValue(t,e){this.vehicle.setSteeringValue(t,e)}setBrake(t,e){this.vehicle.setBrake(t,e)}update(){for(let t=0;t<this.vehicle.wheelInfos.length;t++){this.vehicle.updateWheelTransform(t);const e=this.vehicle.wheelInfos[t].worldTransform;this.wheelBodies[t].position.copy(e.position),this.wheelBodies[t].quaternion.copy(e.quaternion),this.wheelMeshes[t]&&(this.wheelMeshes[t].position.copy(e.position),this.wheelMeshes[t].quaternion.copy(e.quaternion))}}}class Rt{constructor(t=new c(0,2,0)){this.id="car_"+Math.random().toString(36).substr(2,9),this.physics=new Mt(1500,{w:2,h:.8,d:4.5},t),this.maxEngineForce=3e3,this.maxSteeringVal=.5,this.brakeForce=1e5,this.isPlayerDriving=!1,this._buildVisuals(),this._setupWheels()}_buildVisuals(){this.meshGroup=new f;const t=new A(2,.8,4.5);t.translate(0,.4,0);const e=new b({color:16711731,roughness:.2,metalness:.8});this.chassisMesh=new M(t,e),this.chassisMesh.castShadow=!0,this.meshGroup.add(this.chassisMesh),et.scene.add(this.meshGroup)}_setupWheels(){const t=1.4;this.physics.addWheel(-1,0,t,!0),this.physics.addWheel(1,0,t,!0),this.physics.addWheel(-1,0,-t,!1,{frictionSlip:4}),this.physics.addWheel(1,0,-t,!1,{frictionSlip:4});const e=new P(.4,.4,.3,16);e.rotateZ(Math.PI/2);const s=new b({color:1118481,roughness:.9});for(let i=0;i<4;i++){const t=new M(e,s);t.castShadow=!0,et.scene.add(t),this.physics.wheelMeshes.push(t)}}enterVehicle(){this.isPlayerDriving=!0,dt.setTarget(this.meshGroup),dt.mode="TPS"}exitVehicle(){this.isPlayerDriving=!1,this.physics.setSteeringValue(0,0),this.physics.setSteeringValue(0,1),this.physics.applyEngineForce(0,2),this.physics.applyEngineForce(0,3),this.physics.setBrake(this.brakeForce,0),this.physics.setBrake(this.brakeForce,1),this.physics.setBrake(this.brakeForce,2),this.physics.setBrake(this.brakeForce,3)}update(t){const e=this.physics.chassisBody.position,s=this.physics.chassisBody.quaternion;this.meshGroup.position.copy(e),this.meshGroup.quaternion.copy(s),this.physics.update(),this.isPlayerDriving&&this._handleInputs()}_handleInputs(){let t=0,e=0;if(at.actions.moveY>0)t=this.maxEngineForce,this.physics.setBrake(0,0),this.physics.setBrake(0,1),this.physics.setBrake(0,2),this.physics.setBrake(0,3);else if(at.actions.moveY<0){this.physics.chassisBody.velocity.length()>2?e=this.brakeForce:(t=.5*-this.maxEngineForce,this.physics.setBrake(0,0),this.physics.setBrake(0,1),this.physics.setBrake(0,2),this.physics.setBrake(0,3))}else this.physics.setBrake(100,2),this.physics.setBrake(100,3),this.physics.setBrake(0,0),this.physics.setBrake(0,1);at.actions.jump?(e=this.brakeForce,this.physics.setBrake(1.5*e,2),this.physics.setBrake(1.5*e,3),this.physics.setBrake(0,0),this.physics.setBrake(0,1)):e>0&&(this.physics.setBrake(.7*e,0),this.physics.setBrake(.7*e,1),this.physics.setBrake(.3*e,2),this.physics.setBrake(.3*e,3)),this.physics.applyEngineForce(t,2),this.physics.applyEngineForce(t,3);const s=-at.actions.moveX*this.maxSteeringVal;this.physics.setSteeringValue(s,0),this.physics.setSteeringValue(s,1)}}const It=new class{constructor(){this.activeVehicles=[],this.maxTraffic=20,this.spawnRadius=150,this.despawnRadius=250}init(){}update(t,e){for(let s=this.activeVehicles.length-1;s>=0;s--){const i=this.activeVehicles[s];this._simulateDriving(i,t),i.carEntity.update(t);this._distSq(e,i.carEntity.physics.chassisBody.position)>this.despawnRadius*this.despawnRadius&&this._despawnCar(s)}Math.random()>.95&&this.activeVehicles.length<this.maxTraffic&&this._spawnRandomCar(e)}_simulateDriving(t,e){t.carEntity.physics.chassisBody.velocity.length()<15?(t.carEntity.physics.applyEngineForce(1500,2),t.carEntity.physics.applyEngineForce(1500,3),t.carEntity.physics.setBrake(0,0),t.carEntity.physics.setBrake(0,1)):(t.carEntity.physics.applyEngineForce(0,2),t.carEntity.physics.applyEngineForce(0,3)),t.carEntity.physics.setSteeringValue(0,0),t.carEntity.physics.setSteeringValue(0,1)}_spawnRandomCar(t){const e=Math.random()*Math.PI*2,s=t.x+Math.cos(e)*this.spawnRadius,i=t.z+Math.sin(e)*this.spawnRadius,n=new Rt(new c(s,2,i)),a=new nt.cannon.Quaternion;a.setFromAxisAngle(new nt.cannon.Vec3(0,1,0),Math.random()*Math.PI*2),n.physics.chassisBody.quaternion.copy(a),this.activeVehicles.push({id:`traffic_${Date.now()}`,carEntity:n})}_despawnCar(t){const e=this.activeVehicles[t].carEntity;et.scene.remove(e.meshGroup),e.physics.wheelMeshes.forEach(t=>et.scene.remove(t)),nt.world.removeBody(e.physics.chassisBody),e.physics.wheelBodies.forEach(t=>nt.world.removeBody(t)),e.physics.vehicle.removeFromWorld(nt.world),this.activeVehicles.splice(t,1)}_distSq(t,e){const s=t.x-e.x,i=t.y-e.y,n=t.z-e.z;return s*s+i*i+n*n}};const Lt=new class{constructor(){this.activeJob=null,this.activeMissions=[],this.completedMissions=[]}init(){tt.on("time:hour_passed",t=>this._checkWorkSchedule(t.hours))}hire(t){this.activeJob&&this.quitJob(),this.activeJob=t,tt.emit("ui:show_notification",{title:"CAREER",message:`Hired as ${t.title}`,type:"success"})}quitJob(){this.activeJob&&(tt.emit("ui:show_notification",{title:"CAREER",message:`Quit job at ${this.activeJob.company}`,type:"info"}),this.activeJob=null)}_checkWorkSchedule(t){if(this.activeJob&&(t>=this.activeJob.shiftStart&&t<=this.activeJob.shiftEnd&&(this._isPlayerAtWorkspace()?this.activeJob.performWork():this.activeJob.applyPenalty()),t===this.activeJob.shiftEnd+1)){const t=this.activeJob.calculateDailyPay();vt.addMoney(t),tt.emit("ui:show_notification",{title:"PAYDAY",message:`Received ‚Ç¨$${t} from ${this.activeJob.company}`,type:"money"})}}_isPlayerAtWorkspace(){return!0}acceptGig(t){this.activeMissions.push(t),tt.emit("ui:show_notification",{title:"NEW GIG",message:t.title,type:"info"})}completeGig(t){const e=this.activeMissions.findIndex(e=>e.id===t);if(e>-1){const t=this.activeMissions[e];vt.addMoney(t.payout),this.completedMissions.push(t),this.activeMissions.splice(e,1),tt.emit("ui:show_notification",{title:"GIG COMPLETED",message:t.title,type:"success"})}}};const Pt=new class{constructor(){this.globalInflationLevel=1,this.categoryMultipliers={Weapon:1,Consumable:1,Cyberware:1,Junk:1},this.history=[]}init(){tt.on("time:hour_passed",()=>this._simulateMarketShift())}_simulateMarketShift(){const t=.05*(Math.random()-.5);this.globalInflationLevel=Math.max(.5,Math.min(2,this.globalInflationLevel+t));for(const e in this.categoryMultipliers){const t=.1*(Math.random()-.5);this.categoryMultipliers[e]=Math.max(.2,Math.min(5,this.categoryMultipliers[e]+t))}this.history.push({time:Date.now(),global:this.globalInflationLevel,weapons:this.categoryMultipliers.Weapon}),this.history.length>24&&this.history.shift(),tt.emit("economy:market_updated")}getBuyPrice(t){const e=_t.find(e=>e.id===t);if(!e)return 0;const s=this.categoryMultipliers[e.category]||1,i=e.baseValue*this.globalInflationLevel*s;return Math.floor(i)}getSellPrice(t){return Math.floor(.3*this.getBuyPrice(t))}};const At=new class{constructor(){this.coins=[{id:"BTC-2077",name:"BitCred 2077",price:45e3,history:[],volatility:.05,amountOwned:0},{id:"EDG",name:"EdgeCoin",price:120,history:[],volatility:.15,amountOwned:0},{id:"SCM",name:"ScamDoge",price:.05,history:[],volatility:.4,amountOwned:0}],this.coins.forEach(t=>{let e=t.price;for(let s=0;s<20;s++)e*=1+(Math.random()-.5)*t.volatility,t.history.push(e)})}init(){tt.on("time:minute_passed",t=>{t.minutes%10==0&&this._simulateTick()})}_simulateTick(){this.coins.forEach(t=>{let e=0;"SCM"===t.id&&Math.random()>.95&&(e=Math.random()>.5?2:-.8);const s=(Math.random()-.5)*t.volatility+e;t.price=Math.max(.001,t.price*(1+s)),t.history.push(t.price),t.history.length>50&&t.history.shift()}),tt.emit("crypto:market_updated")}buyCoin(t,e){const s=this.coins.find(e=>e.id===t);if(!s||e<=0)return!1;const i=s.price*e;return!!vt.removeMoney(i)&&(s.amountOwned+=e,tt.emit("crypto:portfolio_updated"),!0)}sellCoin(t,e){const s=this.coins.find(e=>e.id===t);if(!s||s.amountOwned<e||e<=0)return!1;const i=s.price*e;return s.amountOwned-=e,vt.addMoney(i),tt.emit("crypto:portfolio_updated"),!0}};const Tt=new class{constructor(){this.balance=0,this.activeLoan=0,this.loanInterestRate=.05,this.savingsInterestRate=.01,this.transactions=[]}init(){tt.on("time:day_passed",()=>this._applyDailyInterest())}deposit(t){return vt.money>=t&&(vt.removeMoney(t),this.balance+=t,this._addHistory("Deposit",t),tt.emit("economy:bank_updated",{balance:this.balance}),!0)}withdraw(t){return this.balance>=t&&(this.balance-=t,vt.addMoney(t),this._addHistory("Withdrawal",-t),tt.emit("economy:bank_updated",{balance:this.balance}),!0)}takeLoan(t){return this.activeLoan>0?(tt.emit("ui:show_notification",{title:"BANK",message:"Pay back existing loan first.",type:"error"}),!1):(this.activeLoan=t,this.balance+=t,this._addHistory("Loan Approved",t),tt.emit("economy:bank_updated",{balance:this.balance}),!0)}payLoan(t){if(this.activeLoan<=0)return!1;const e=Math.min(t,this.activeLoan);return this.balance>=e&&(this.balance-=e,this.activeLoan-=e,this._addHistory("Loan Payment",-e),tt.emit("economy:bank_updated",{balance:this.balance}),0===this.activeLoan&&tt.emit("ui:show_notification",{title:"BANK",message:"Loan Fully Paid.",type:"success"}),!0)}_applyDailyInterest(){if(this.balance>0){const t=Math.floor(this.balance*this.savingsInterestRate);this.balance+=t,t>0&&this._addHistory("Daily Interest",t)}if(this.activeLoan>0){const t=Math.floor(this.activeLoan*this.loanInterestRate);this.activeLoan+=t,tt.emit("ui:show_notification",{title:"BANK ALERT",message:`Loan interest applied: ‚Ç¨$${t}`,type:"error"})}tt.emit("economy:bank_updated",{balance:this.balance})}_addHistory(t,e){this.transactions.unshift({date:(new Date).toLocaleDateString(),desc:t,amount:e}),this.transactions.length>50&&this.transactions.pop()}};const xt=new class{constructor(){this.inCombat=!1,this.combatTimer=0}init(){tt.on("combat:fire",t=>this._resolveShot(t)),tt.on("combat:melee",t=>this._resolveMelee(t)),tt.on("combat:explosion",t=>this._resolveExplosion(t))}update(t){this.inCombat&&(this.combatTimer-=t,this.combatTimer<=0&&this._exitCombat())}_enterCombat(){this.inCombat||(this.inCombat=!0,tt.emit("world:combat_started")),this.combatTimer=10}_exitCombat(){this.inCombat=!1,tt.emit("world:combat_ended")}_resolveShot({sourceId:t,targetId:e,damage:s,hitPosition:i,isCritical:n}){if(this._enterCombat(),"player"===e){const t=n?2*s:s;vt.stats.applyDamage(t),tt.emit("ui:show_damage_indicator",i)}else tt.emit("combat:hit_npc",{id:e,damage:s}),"player"===t&&tt.emit("ui:play_hitmarker")}_resolveMelee({sourceId:t,targetId:e,damage:s,hitPosition:i}){this._enterCombat(),"player"===e?vt.stats.applyDamage(s):tt.emit("combat:hit_npc",{id:e,damage:s})}_resolveExplosion({position:t,radius:e,maxDamage:s}){this._enterCombat();const i=this._distSq(t,vt.controller.getPosition());if(i<e*e){const t=1-Math.sqrt(i)/e,n=Math.floor(s*t);vt.stats.applyDamage(n),tt.emit("camera:shake",{intensity:5*t,duration:1})}tt.emit("world:explosion",t)}_distSq(t,e){const s=t.x-e.x,i=t.y-e.y,n=t.z-e.z;return s*s+i*i+n*n}};const kt=new class{constructor(){this.activeEffects=[]}init(){}update(t){for(let e=this.activeEffects.length-1;e>=0;e--){const s=this.activeEffects[e];s.duration-=t,s.timer+=t,s.timer>=s.tickRate&&(s.timer=0,"player"===s.targetId?(vt.stats.applyDamage(s.damagePerTick),tt.emit("ui:show_notification",{title:"STATUS",message:`Taking ${s.type} damage!`,type:"error"})):tt.emit("combat:hit_npc",{id:s.targetId,damage:s.damagePerTick})),s.duration<=0&&this.activeEffects.splice(e,1)}}applyEffect(t,e,s,i){const n=this.activeEffects.find(s=>s.targetId===t&&s.type===e);n?n.duration=Math.max(n.duration,s):(this.activeEffects.push({targetId:t,type:e,duration:s,tickRate:1,damagePerTick:i,timer:0}),"player"===t&&tt.emit(`status:applied_${e}`))}};(new class{constructor(){this.isReady=!1,this._bootProgressFill=null,this._bootStatusText=null}async boot(){Q.info("LIFE","D√©marrage de LIFE RPG..."),this._bootProgressFill=document.getElementById("boot-progress-fill"),this._bootStatusText=document.getElementById("boot-status-text");try{this._setProgress(5,"Chargement des assets..."),"function"==typeof ct.init&&await ct.init();try{await ct.preloadRegistryAssets()}catch(t){Q.warn("AssetLoader","Erreurs de pr√©chargement (placeholders GLTF ignor√©s).")}if(this._setProgress(20,"Initialisation du moteur 3D..."),et.init("game-canvas-container"),!et.isInitialized)throw new Error("√âchec critique : moteur WebGL non initialis√©.");this._setProgress(35,"Initialisation physique et inputs..."),nt.init(),at.init("game-canvas-container"),it.init(),dt.init(et.camera),this._setProgress(50,"Chargement du syst√®me de sauvegarde..."),await ut.init(),this._setProgress(60,"Initialisation de l'interface..."),mt.init(),this._setProgress(70,"G√©n√©ration du monde..."),pt.init(),bt.init(),It.init(),this._setProgress(85,"Initialisation des syst√®mes..."),Lt.init(),Pt.init(),At.init(),Tt.init(),xt.init(),kt.init(),this._setProgress(95,"Lancement de la boucle principale..."),this._setupGlobalEvents(),st.addUpdate(this.update.bind(this),100),st.addRender(this._render.bind(this),100),st.start(),this.isReady=!0,this._setProgress(100,"Pr√™t !"),Q.info("LIFE","Moteur LIFE RPG pr√™t."),await this._delay(400),this._hideBootScreen(),await this._delay(900),this.startGameplay()}catch(e){Q.fatal("LIFE","Erreur critique lors du boot",e),this._setProgress(0,`‚ùå Erreur : ${e.message}`)}}startGameplay(){vt.init(new c(0,5,0)),vt.setIdentity("V","streetkid",2500),tt.emit("ui:show_hud")}update(t){if(!this.isReady)return;at.update(),vt.update(t),nt.update(t);const e=vt.controller?vt.controller.getPosition():null;e&&(pt.update(t,e),bt.update(t,e),It.update(t,e)),xt.update(t),kt.update(t)}_render(t,e){this.isReady&&et.render()}_setProgress(t,e){this._bootProgressFill&&(this._bootProgressFill.style.width=`${t}%`),this._bootStatusText&&(this._bootStatusText.textContent=e),Q.info("Boot",`[${t}%] ${e}`)}_hideBootScreen(){const t=document.getElementById("boot-screen");t&&(t.classList.add("fade-out"),setTimeout(()=>{t.style.display="none"},900))}_delay(t){return new Promise(e=>setTimeout(e,t))}_setupGlobalEvents(){window.addEventListener("resize",()=>{et.resize()}),tt.on("assets:progress",({progress:t})=>{this._setProgress(Math.round(5+15*t),"Chargement des assets...")}),tt.on("ui:show_hud",()=>{const t=document.getElementById("hud-container");t&&t.classList.remove("hidden")}),tt.on("ui:hide_hud",()=>{const t=document.getElementById("hud-container");t&&t.classList.add("hidden")}),tt.on("gameloop:pause",()=>{st.stop()}),tt.on("gameloop:resume",()=>{st.start()}),document.addEventListener("keydown",t=>{t.key}),document.addEventListener("visibilitychange",()=>{document.hidden?Q.info("LIFE","Page masqu√©e ‚Äî Pause de la boucle"):Q.info("LIFE","Page visible ‚Äî Reprise")})}}).boot();
